services:
    # ============================================================================
    # RustAssistant Web UI Server
    # ============================================================================
    rustassistant-web:
        build:
            context: .
            dockerfile: docker/Dockerfile.web
        container_name: rustassistant-web
        restart: unless-stopped
        ports:
            - "3001:3001"
        environment:
            - HOST=0.0.0.0
            - PORT=3001
            - RUST_LOG=info,rustassistant=debug
            - XAI_API_KEY=${XAI_API_KEY}
            - XAI_BASE_URL=https://api.x.ai/v1
            - DATABASE_PATH=/app/data/rustassistant.db
            - CACHE_DB_PATH=/app/data/rustassistant_cache.db
            - REDIS_URL=redis://redis:6379
        volumes:
            - ./data:/app/data
            - ./templates:/app/templates:ro
            - ./config:/app/config:ro
        depends_on:
            redis:
                condition: service_healthy
        networks:
            - rustassistant
        healthcheck:
            test:
                [
                    "CMD",
                    "wget",
                    "--no-verbose",
                    "--tries=1",
                    "--spider",
                    "http://localhost:3001/",
                ]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s

    # ============================================================================
    # RustAssistant CLI (for scheduled tasks, batch jobs)
    # ============================================================================
    rustassistant-cli:
        build:
            context: .
            dockerfile: docker/Dockerfile.cli
        container_name: rustassistant-cli
        restart: "no"
        environment:
            - RUST_LOG=info,rustassistant=debug
            - XAI_API_KEY=${XAI_API_KEY}
            - XAI_BASE_URL=https://api.x.ai/v1
            - DATABASE_PATH=/app/data/rustassistant.db
            - CACHE_DB_PATH=/app/data/rustassistant_cache.db
            - REDIS_URL=redis://redis:6379
        volumes:
            - ./data:/app/data
            - ./repos:/app/repos
            - ./config:/app/config:ro
        depends_on:
            - redis
        networks:
            - rustassistant
        profiles:
            - cli

    # ============================================================================
    # Redis Cache - For LLM Response Caching
    # ============================================================================
    redis:
        image: redis:7-alpine
        container_name: rustassistant-redis
        restart: unless-stopped
        command: >
            redis-server
            --maxmemory 512mb
            --maxmemory-policy allkeys-lru
            --save 60 1
            --appendonly yes
            --appendfsync everysec
        ports:
            - "6379:6379"
        volumes:
            - redis_data:/data
        networks:
            - rustassistant
        healthcheck:
            test: ["CMD", "redis-cli", "ping"]
            interval: 10s
            timeout: 5s
            retries: 5
        deploy:
            resources:
                limits:
                    memory: 512M
                reservations:
                    memory: 256M

    # ============================================================================
    # PostgreSQL Database (Future - for multi-user deployments)
    # ============================================================================
    # postgres:
    #   image: postgres:16-alpine
    #   container_name: rustassistant-postgres
    #   restart: unless-stopped
    #   environment:
    #     - POSTGRES_USER=rustassistant
    #     - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-rustassistant}
    #     - POSTGRES_DB=rustassistant
    #   volumes:
    #     - postgres_data:/var/lib/postgresql/data
    #   networks:
    #     - rustassistant
    #   healthcheck:
    #     test: ["CMD-SHELL", "pg_isready -U rustassistant"]
    #     interval: 10s
    #     timeout: 5s
    #     retries: 5
    #   deploy:
    #     resources:
    #       limits:
    #         memory: 256M

volumes:
    redis_data:
        driver: local
    # postgres_data:
    #   driver: local

networks:
    rustassistant:
        driver: bridge
        name: rustassistant-network
