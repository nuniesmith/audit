# ============================================================================
# FKS LLM Audit Workflow
# ============================================================================
# Manual LLM-powered code audit for deeper analysis with JANUS-specific features.
#
# This workflow is triggered manually and uses LLM providers to analyze code.
# Static audits run automatically in ci-cd.yml - this is for optional AI insights.
#
# NOTE: This workflow requires the custom audit CLI in src/audit/
# Build it with: cd src/audit && cargo build --release
#
# Supported Providers:
# - xAI (Grok) - Default, fast and cost-effective
# - Anthropic (Claude Opus 4.5) - Best for deep analysis and JANUS conformity
# - Google (Gemini) - Alternative option
#
# Required Secrets:
# - XAI_API_KEY: xAI API key (for Grok)
# - ANTHROPIC_API_KEY: Anthropic API key (for Claude)
# - GOOGLE_API_KEY: Google API key (for Gemini)
# ============================================================================

name: ðŸ¤– LLM Audit

on:
    workflow_dispatch:
        inputs:
            audit_mode:
                description: "Audit Mode"
                required: true
                type: choice
                default: "regular"
                options:
                    - regular
                    - full
                    - janus
            llm_provider:
                description: "LLM Provider"
                required: true
                type: choice
                default: "xai"
                options:
                    - xai
                    - google
                    - anthropic
                    - claude-opus
                    - claude-sonnet
            focus_point:
                description: "Focus area (e.g., 'security', 'risk management', 'performance', 'neuromorphic', 'gaf', 'ltn', 'memory', 'compliance')"
                required: false
                type: string
                default: ""
            verify_math:
                description: "Enable deep mathematical verification (JANUS mode only)"
                required: false
                type: boolean
                default: false
            verify_mappings:
                description: "Enable brain-region mapping verification (JANUS mode only)"
                required: false
                type: boolean
                default: false
            compliance_report:
                description: "Generate compliance report (JANUS mode only)"
                required: false
                type: boolean
                default: false
            whitepaper_sections:
                description: "Specific whitepaper sections to check (comma-separated, e.g., '3.1,4.2,5')"
                required: false
                type: string
                default: ""

permissions:
    contents: write
    actions: read

env:
    RUST_VERSION: stable
    CARGO_TERM_COLOR: always

jobs:
    llm-audit:
        name: ðŸ¤– ${{ inputs.audit_mode == 'full' && 'Full' || inputs.audit_mode == 'janus' && 'JANUS Conformity' || 'Regular' }} LLM Audit (${{ inputs.llm_provider }})
        runs-on: ubuntu-latest
        timeout-minutes: ${{ inputs.audit_mode == 'full' && 120 || inputs.audit_mode == 'janus' && 90 || 30 }}

        steps:
            # ================================================================
            # Setup
            # ================================================================

            - name: ðŸ“¥ Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: ðŸ¦€ Setup Rust
              uses: nuniesmith/actions/.github/actions/setup-rust@main
              with:
                  rust-version: ${{ env.RUST_VERSION }}
                  cache-key-suffix: llm-audit

            - name: ðŸ” Validate API keys
              env:
                  HAS_XAI_KEY: ${{ secrets.XAI_API_KEY != '' }}
                  HAS_ANTHROPIC_KEY: ${{ secrets.ANTHROPIC_API_KEY != '' }}
                  HAS_GOOGLE_KEY: ${{ secrets.GOOGLE_API_KEY != '' }}
              run: |
                  PROVIDER="${{ inputs.llm_provider }}"
                  MISSING=""

                  case "$PROVIDER" in
                      xai)
                          [ "$HAS_XAI_KEY" != "true" ] && MISSING="XAI_API_KEY"
                          ;;
                      anthropic|claude-opus|claude-sonnet)
                          [ "$HAS_ANTHROPIC_KEY" != "true" ] && MISSING="ANTHROPIC_API_KEY"
                          ;;
                      google)
                          [ "$HAS_GOOGLE_KEY" != "true" ] && MISSING="GOOGLE_API_KEY"
                          ;;
                  esac

                  if [ -n "$MISSING" ]; then
                      echo "âŒ Missing required secret: $MISSING for provider: $PROVIDER"
                      echo "## âŒ Missing API Key" >> $GITHUB_STEP_SUMMARY
                      echo "" >> $GITHUB_STEP_SUMMARY
                      echo "The secret \`$MISSING\` is required for the \`$PROVIDER\` provider." >> $GITHUB_STEP_SUMMARY
                      exit 1
                  fi

                  echo "âœ… API key validated for provider: $PROVIDER"

            - name: ðŸ”¨ Build audit CLI
              working-directory: src/audit
              run: |
                  echo "## ðŸ”¨ Building Audit CLI" >> $GITHUB_STEP_SUMMARY
                  cargo build --release
                  echo "âœ… Audit CLI built successfully" >> $GITHUB_STEP_SUMMARY

            # ================================================================
            # Static Analysis & Scoring
            # ================================================================

            - name: ðŸ“Š Run static analysis and file scoring
              id: static
              working-directory: src/audit
              run: |
                  echo "## ðŸ“Š Static Analysis & File Scoring" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**Audit Mode:** ${{ inputs.audit_mode }}" >> $GITHUB_STEP_SUMMARY
                  echo "**Provider:** ${{ inputs.llm_provider }}" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY

                  # Run static analysis
                  cargo run --release --bin audit-cli -- static \
                      ../../src/janus \
                      --output static-analysis.json || echo '{}' > static-analysis.json

                  # Run TODO scan
                  cargo run --release --bin audit-cli -- todo \
                      ../../src/janus \
                      --output todos.json || echo '[]' > todos.json

                  # Run tag scan
                  cargo run --release --bin audit-cli -- tags \
                      ../../src/janus \
                      --output audit-tags.json || echo '[]' > audit-tags.json

                  # Output counts
                  TODO_COUNT=$(jq 'length' todos.json 2>/dev/null || echo "0")
                  TAG_COUNT=$(jq 'length' audit-tags.json 2>/dev/null || echo "0")

                  echo "- TODOs found: $TODO_COUNT" >> $GITHUB_STEP_SUMMARY
                  echo "- Audit tags: $TAG_COUNT" >> $GITHUB_STEP_SUMMARY

            # ================================================================
            # Build Context for LLM
            # ================================================================

            - name: ðŸ“¦ Build context bundle
              id: context
              working-directory: src/audit
              run: |
                  echo "## ðŸ“¦ Building Context" >> $GITHUB_STEP_SUMMARY

                  if [ "${{ inputs.audit_mode }}" = "full" ] || [ "${{ inputs.audit_mode }}" = "janus" ]; then
                      echo "Building comprehensive file-by-file context..." >> $GITHUB_STEP_SUMMARY
                      # Full/JANUS audit: prepare individual files for analysis
                      mkdir -p context-bundle/files
                      find ../../src/janus -type f \( -name "*.rs" -o -name "*.toml" -o -name "*.proto" \) \
                          -not -path "*/target/*" \
                          -not -path "*/.git/*" \
                          > context-bundle/file-list.txt

                      FILE_COUNT=$(wc -l < context-bundle/file-list.txt)
                      echo "- Files to analyze: $FILE_COUNT" >> $GITHUB_STEP_SUMMARY
                  else
                      echo "Building holistic codebase context..." >> $GITHUB_STEP_SUMMARY
                      # Regular audit: build comprehensive context
                      mkdir -p context-bundle
                      cargo run --release --bin audit-cli -- tree \
                          ../../src/janus \
                          --with-tags \
                          --output context-bundle/tree.json || echo '{}' > context-bundle/tree.json

                      echo "- Context: Full codebase tree with tags" >> $GITHUB_STEP_SUMMARY
                  fi

            # ================================================================
            # LLM Analysis
            # ================================================================

            - name: ðŸ¤– Run ${{ inputs.audit_mode }} LLM audit
              id: llm_analysis
              working-directory: src/audit
              env:
                  XAI_API_KEY: ${{ secrets.XAI_API_KEY }}
                  GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
                  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
              run: |
                  echo "## ðŸ¤– LLM Analysis (${{ inputs.audit_mode }} mode)" >> $GITHUB_STEP_SUMMARY

                  # Determine the actual provider for Claude variants
                  PROVIDER="${{ inputs.llm_provider }}"
                  case "$PROVIDER" in
                      claude-opus)
                          PROVIDER="opus"
                          ;;
                      claude-sonnet)
                          PROVIDER="sonnet"
                          ;;
                      anthropic)
                          PROVIDER="anthropic"
                          ;;
                  esac

                  FOCUS_ARG=""
                  if [ -n "${{ inputs.focus_point }}" ]; then
                      FOCUS_ARG="--focus ${{ inputs.focus_point }}"
                  fi

                  # ================================================================
                  # JANUS Whitepaper Conformity Audit
                  # ================================================================
                  if [ "${{ inputs.audit_mode }}" = "janus" ]; then
                      echo "ðŸ§  Running JANUS WHITEPAPER CONFORMITY AUDIT" >> $GITHUB_STEP_SUMMARY
                      echo "" >> $GITHUB_STEP_SUMMARY
                      echo "Using Claude Opus 4.5 for deep analysis against JANUS technical specification." >> $GITHUB_STEP_SUMMARY
                      echo "" >> $GITHUB_STEP_SUMMARY
                      echo "This will verify:" >> $GITHUB_STEP_SUMMARY
                      echo "1. GAF transformation mathematics" >> $GITHUB_STEP_SUMMARY
                      echo "2. LTN Åukasiewicz logic implementation" >> $GITHUB_STEP_SUMMARY
                      echo "3. Brain-region component mappings" >> $GITHUB_STEP_SUMMARY
                      echo "4. Memory hierarchy (hippocampus, SWR, neocortex)" >> $GITHUB_STEP_SUMMARY
                      echo "5. Compliance constraints (wash sale, position limits)" >> $GITHUB_STEP_SUMMARY
                      echo "" >> $GITHUB_STEP_SUMMARY

                      # Build JANUS audit arguments
                      JANUS_ARGS=""
                      if [ "${{ inputs.verify_math }}" = "true" ]; then
                          JANUS_ARGS="$JANUS_ARGS --verify-math"
                      fi
                      if [ "${{ inputs.verify_mappings }}" = "true" ]; then
                          JANUS_ARGS="$JANUS_ARGS --verify-mappings"
                      fi
                      if [ "${{ inputs.compliance_report }}" = "true" ]; then
                          JANUS_ARGS="$JANUS_ARGS --compliance-report"
                      fi
                      if [ -n "${{ inputs.whitepaper_sections }}" ]; then
                          JANUS_ARGS="$JANUS_ARGS --sections ${{ inputs.whitepaper_sections }}"
                      fi

                      # Default to Claude Opus for JANUS audits if not specified
                      if [ "$PROVIDER" = "xai" ] || [ "$PROVIDER" = "google" ]; then
                          echo "âš ï¸ JANUS audit recommended with Claude Opus 4.5. Using $PROVIDER as requested." >> $GITHUB_STEP_SUMMARY
                      fi

                      # JANUS audit command
                      cargo run --release --bin audit-cli -- janus-audit \
                          ../../src/janus \
                          --provider ${PROVIDER:-opus} \
                          --focus "${{ inputs.focus_point || 'all' }}" \
                          $JANUS_ARGS \
                          --output llm-audit-result.json || echo '{"audit_type":"janus_whitepaper_conformity","results":{"overall_health":0,"architecture_assessment":"Audit failed"}}' > llm-audit-result.json

                  # ================================================================
                  # Full Audit (File-by-file)
                  # ================================================================
                  elif [ "${{ inputs.audit_mode }}" = "full" ]; then
                      echo "ðŸ”¬ Running FULL AUDIT - File-by-file analysis with scoring and master review" >> $GITHUB_STEP_SUMMARY
                      echo "" >> $GITHUB_STEP_SUMMARY
                      echo "This will:" >> $GITHUB_STEP_SUMMARY
                      echo "1. Score all files based on audit tags and complexity" >> $GITHUB_STEP_SUMMARY
                      echo "2. Analyze each important file individually with LLM" >> $GITHUB_STEP_SUMMARY
                      echo "3. Assess file relationships and dependencies" >> $GITHUB_STEP_SUMMARY
                      echo "4. Generate master review synthesizing all findings" >> $GITHUB_STEP_SUMMARY
                      echo "" >> $GITHUB_STEP_SUMMARY

                      # Full audit - outputs JSON
                      cargo run --release --bin audit-cli -- llm-audit \
                          ../../src/janus \
                          --mode full \
                          --provider $PROVIDER \
                          $FOCUS_ARG \
                          --output llm-audit-result.json || echo '{"mode":"Full","file_analyses":[],"master_review":{"executive_summary":"Audit failed"},"overall_health":0}' > llm-audit-result.json

                  # ================================================================
                  # Regular Audit (Holistic)
                  # ================================================================
                  else
                      echo "ðŸ” Running REGULAR AUDIT - Holistic codebase analysis" >> $GITHUB_STEP_SUMMARY
                      echo "" >> $GITHUB_STEP_SUMMARY
                      echo "This will:" >> $GITHUB_STEP_SUMMARY
                      echo "1. Analyze entire codebase holistically" >> $GITHUB_STEP_SUMMARY
                      echo "2. Identify architecture patterns and issues" >> $GITHUB_STEP_SUMMARY
                      echo "3. Assess overall code quality and security" >> $GITHUB_STEP_SUMMARY
                      echo "4. Provide strategic recommendations" >> $GITHUB_STEP_SUMMARY
                      echo "" >> $GITHUB_STEP_SUMMARY

                      # Regular audit - outputs JSON
                      cargo run --release --bin audit-cli -- llm-audit \
                          ../../src/janus \
                          --mode regular \
                          --provider $PROVIDER \
                          $FOCUS_ARG \
                          --output llm-audit-result.json || echo '{"mode":"Regular","architecture_assessment":"Audit failed","overall_health":0}' > llm-audit-result.json
                  fi

                  echo "âœ… LLM audit complete" >> $GITHUB_STEP_SUMMARY

            # ================================================================
            # Convert Results to Report Format
            # ================================================================

            - name: ðŸ“‹ Convert audit result to report format
              working-directory: src/audit
              run: |
                  echo "## ðŸ“‹ Generating report format" >> $GITHUB_STEP_SUMMARY

                  # Convert Rust CLI JSON output to simplified report format
                  if [ -f llm-audit-result.json ]; then
                      if [ "${{ inputs.audit_mode }}" = "janus" ]; then
                          # Extract from JANUS conformity audit result
                          jq '{
                              audit_type: "janus_whitepaper_conformity",
                              summary: (.results.architecture_assessment // "JANUS conformity audit completed"),
                              overall_health: (.results.overall_health // 0),
                              confidence: (.results.confidence // 0),
                              priority_actions: ([.results.recommendations[]?.recommendation? // .results.recommendations[]?] | .[0:5]),
                              findings: ([.results.security_concerns[]? | {
                                  severity: (.severity // "medium"),
                                  category: "conformity",
                                  title: (.title // .description),
                                  description: .description,
                                  recommendation: (.recommendation // "Review and address"),
                                  files: (.affected_areas // [])
                              }] // []),
                              patterns: (.results.patterns // []),
                              quality_observations: (.results.quality_observations // []),
                              tech_debt: (.results.tech_debt_areas[]?.description // []),
                              next_steps: ([.results.recommendations[]?.recommendation? // .results.recommendations[]?] | .[0:5])
                          }' llm-audit-result.json > llm-analysis.json 2>/dev/null || \
                              echo '{"audit_type": "janus_whitepaper_conformity", "summary": "Report conversion failed", "findings": []}' > llm-analysis.json

                      elif [ "${{ inputs.audit_mode }}" = "full" ]; then
                          # Extract from Full audit result
                          jq '{
                              summary: (.master_review.executive_summary // "Full audit completed"),
                              priority_actions: (.master_review.top_priorities // []),
                              findings: ([.file_analyses[]?.llm_analysis.issues[]? | {
                                  severity: .severity,
                                  category: .category,
                                  title: .description,
                                  description: .description,
                                  recommendation: .suggestion,
                                  files: [.file // "unknown"]
                              }] // []),
                              tech_debt: (.master_review.weaknesses // []),
                              next_steps: (.master_review.action_plan // [])
                          }' llm-audit-result.json > llm-analysis.json 2>/dev/null || \
                              echo '{"summary": "Report conversion failed", "findings": []}' > llm-analysis.json
                      else
                          # Extract from Regular audit result
                          jq '{
                              summary: (.architecture_assessment // "Regular audit completed"),
                              priority_actions: ([.recommendations[]?.action? // .recommendations[]?] | .[0:5]),
                              findings: ([.security_concerns[]? | {
                                  severity: (.severity // "medium"),
                                  category: "security",
                                  title: (.title // .description),
                                  description: .description,
                                  recommendation: (.mitigation // "Review and address"),
                                  files: (.affected_files // [])
                              }] // []),
                              tech_debt: (.tech_debt_areas[]?.description // []),
                              next_steps: ([.recommendations[]?.action? // .recommendations[]?] | .[0:5])
                          }' llm-audit-result.json > llm-analysis.json 2>/dev/null || \
                              echo '{"summary": "Report conversion failed", "findings": []}' > llm-analysis.json
                      fi
                  else
                      echo '{"summary": "No audit result found", "findings": []}' > llm-analysis.json
                  fi

                  echo "âœ… Report format ready" >> $GITHUB_STEP_SUMMARY

            # ================================================================
            # Generate Report
            # ================================================================

            - name: ðŸ“„ Generate audit report
              working-directory: src/audit
              run: |
                  if [ "${{ inputs.audit_mode }}" = "janus" ]; then
                      REPORT="../../docs/audit/LLM_JANUS_CONFORMITY_REPORT.md"
                      REPORT_TITLE="ðŸ§  JANUS Whitepaper Conformity Report"
                  else
                      REPORT="../../docs/audit/LLM_AUDIT_REPORT.md"
                      REPORT_TITLE="ðŸ¤– LLM Audit Report"
                  fi

                  # Ensure docs/audit directory exists
                  mkdir -p ../../docs/audit

                  DATE=$(date -u +"%Y-%m-%d %H:%M UTC")

                  # Determine provider display name
                  PROVIDER_DISPLAY="${{ inputs.llm_provider }}"
                  case "$PROVIDER_DISPLAY" in
                      claude-opus)
                          PROVIDER_DISPLAY="Claude Opus 4.5 (Anthropic)"
                          ;;
                      claude-sonnet)
                          PROVIDER_DISPLAY="Claude Sonnet 4 (Anthropic)"
                          ;;
                      anthropic)
                          PROVIDER_DISPLAY="Claude Opus 4.5 (Anthropic)"
                          ;;
                      xai)
                          PROVIDER_DISPLAY="Grok (xAI)"
                          ;;
                      google)
                          PROVIDER_DISPLAY="Gemini (Google)"
                          ;;
                  esac

                  cat > "$REPORT" << HEADER
                  # $REPORT_TITLE

                  > Generated by LLM audit workflow

                  **Date:** $DATE
                  **Provider:** $PROVIDER_DISPLAY
                  **Mode:** ${{ inputs.audit_mode }}
                  **Focus:** ${{ inputs.focus_point || 'General' }}
                  **Run:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

                  HEADER

                  # Add JANUS-specific header if applicable
                  if [ "${{ inputs.audit_mode }}" = "janus" ]; then
                      cat >> "$REPORT" << JANUS_HEADER

                  ## ðŸ§  JANUS Conformity Verification

                  This audit verifies implementation conformity against the JANUS technical whitepaper.

                  **Verification Options:**
                  - Mathematical Verification: ${{ inputs.verify_math }}
                  - Brain-Region Mappings: ${{ inputs.verify_mappings }}
                  - Compliance Report: ${{ inputs.compliance_report }}
                  - Whitepaper Sections: ${{ inputs.whitepaper_sections || 'All' }}

                  JANUS_HEADER

                      # Add conformity score
                      echo "### ðŸ“Š Conformity Score" >> "$REPORT"
                      echo "" >> "$REPORT"
                      HEALTH=$(jq -r '.overall_health // 0' llm-analysis.json 2>/dev/null || echo "0")
                      CONFIDENCE=$(jq -r '.confidence // 0' llm-analysis.json 2>/dev/null || echo "0")
                      echo "- **Overall Conformity:** ${HEALTH}%" >> "$REPORT"
                      echo "- **Confidence Level:** ${CONFIDENCE}%" >> "$REPORT"
                      echo "" >> "$REPORT"
                  fi

                  echo "---" >> "$REPORT"
                  echo "" >> "$REPORT"
                  echo "## ðŸ“‹ Summary" >> "$REPORT"
                  echo "" >> "$REPORT"

                  # Add LLM summary
                  jq -r '.summary // "No summary available"' llm-analysis.json >> "$REPORT" 2>/dev/null || echo "Analysis pending" >> "$REPORT"

                  echo "" >> "$REPORT"

                  # Add patterns if JANUS mode
                  if [ "${{ inputs.audit_mode }}" = "janus" ]; then
                      echo "---" >> "$REPORT"
                      echo "" >> "$REPORT"
                      echo "## ðŸ“‹ Detected Patterns" >> "$REPORT"
                      echo "" >> "$REPORT"
                      jq -r '.patterns // [] | .[] | "- \(.)"' llm-analysis.json >> "$REPORT" 2>/dev/null || echo "- No patterns recorded" >> "$REPORT"
                      echo "" >> "$REPORT"

                      echo "## ðŸ“ Quality Observations" >> "$REPORT"
                      echo "" >> "$REPORT"
                      jq -r '.quality_observations // [] | .[] | "- \(.)"' llm-analysis.json >> "$REPORT" 2>/dev/null || echo "- No observations recorded" >> "$REPORT"
                      echo "" >> "$REPORT"
                  fi

                  echo "---" >> "$REPORT"
                  echo "" >> "$REPORT"
                  echo "## ðŸŽ¯ Priority Actions" >> "$REPORT"
                  echo "" >> "$REPORT"

                  jq -r '.priority_actions // [] | .[] | "1. \(.)"' llm-analysis.json >> "$REPORT" 2>/dev/null || echo "- Review findings below" >> "$REPORT"

                  echo "" >> "$REPORT"
                  echo "---" >> "$REPORT"
                  echo "" >> "$REPORT"
                  echo "## ðŸ” Findings" >> "$REPORT"
                  echo "" >> "$REPORT"

                  jq -r '
                      .findings // [] | sort_by(.severity) | reverse | .[] |
                      "### \(.severity | ascii_upcase): \(.title)\n\n" +
                      "**Category:** \(.category)\n\n" +
                      "\(.description)\n\n" +
                      "**Recommendation:** \(.recommendation)\n\n" +
                      (if .files then "**Files:** " + (.files | join(", ")) + "\n\n" else "" end) +
                      "---\n"
                  ' llm-analysis.json >> "$REPORT" 2>/dev/null || echo "No findings recorded" >> "$REPORT"

                  echo "" >> "$REPORT"
                  echo "## ðŸ“ Technical Debt" >> "$REPORT"
                  echo "" >> "$REPORT"

                  jq -r '.tech_debt // [] | .[] | "- \(.)"' llm-analysis.json >> "$REPORT" 2>/dev/null || echo "- No items identified" >> "$REPORT"

                  echo "" >> "$REPORT"
                  echo "---" >> "$REPORT"
                  echo "" >> "$REPORT"
                  echo "## âž¡ï¸ Next Steps" >> "$REPORT"
                  echo "" >> "$REPORT"

                  jq -r '.next_steps // [] | to_entries | .[] | "\(.key + 1). \(.value)"' llm-analysis.json >> "$REPORT" 2>/dev/null || echo "1. Review findings above" >> "$REPORT"

                  echo "" >> "$REPORT"
                  echo "---" >> "$REPORT"
                  echo "" >> "$REPORT"
                  echo "*This report was auto-generated. Run the workflow again for updated analysis.*" >> "$REPORT"

                  echo "Report generated: $REPORT"

            # ================================================================
            # Commit Results
            # ================================================================

            - name: ðŸ’¾ Commit audit results
              continue-on-error: true
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

                  # Add all audit-related files
                  git add docs/audit/LLM_AUDIT_REPORT.md docs/audit/LLM_JANUS_CONFORMITY_REPORT.md 2>/dev/null || true
                  git add docs/audit/ 2>/dev/null || true

                  if git diff --staged --quiet; then
                      echo "No changes to commit"
                  else
                      git commit -m "ðŸ¤– ${{ inputs.audit_mode }} audit report (${{ inputs.llm_provider }}) [skip ci]"
                      git push
                  fi

            # ================================================================
            # Upload Artifacts
            # ================================================================

            - name: ðŸ“¦ Upload artifacts
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: llm-audit-${{ inputs.audit_mode }}-${{ inputs.llm_provider }}-${{ github.run_number }}
                  path: |
                      src/audit/static-analysis.json
                      src/audit/todos.json
                      src/audit/audit-tags.json
                      src/audit/llm-audit-result.json
                      src/audit/llm-analysis.json
                      src/audit/context-bundle/
                      docs/audit/LLM_AUDIT_REPORT.md
                      docs/audit/LLM_JANUS_CONFORMITY_REPORT.md
                  retention-days: 30

            # ================================================================
            # Summary
            # ================================================================

            - name: âœ… Summary
              run: |
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "---" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "## âœ… Audit Complete" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY

                  if [ "${{ inputs.audit_mode }}" = "janus" ]; then
                      echo "### ðŸ§  JANUS Whitepaper Conformity Audit" >> $GITHUB_STEP_SUMMARY
                      echo "" >> $GITHUB_STEP_SUMMARY
                      echo "- ðŸ“„ Report: [docs/audit/LLM_JANUS_CONFORMITY_REPORT.md](../../docs/audit/LLM_JANUS_CONFORMITY_REPORT.md)" >> $GITHUB_STEP_SUMMARY
                      echo "- ðŸ¤– Model: Claude Opus 4.5 (Anthropic's most capable)" >> $GITHUB_STEP_SUMMARY
                      echo "- ðŸŽ¯ Focus: ${{ inputs.focus_point || 'all' }}" >> $GITHUB_STEP_SUMMARY
                      echo "" >> $GITHUB_STEP_SUMMARY
                      echo "**Verification Options:**" >> $GITHUB_STEP_SUMMARY
                      echo "- Mathematical Verification: ${{ inputs.verify_math }}" >> $GITHUB_STEP_SUMMARY
                      echo "- Brain-Region Mappings: ${{ inputs.verify_mappings }}" >> $GITHUB_STEP_SUMMARY
                      echo "- Compliance Report: ${{ inputs.compliance_report }}" >> $GITHUB_STEP_SUMMARY
                  else
                      echo "- ðŸ“„ Report: [docs/audit/LLM_AUDIT_REPORT.md](../../docs/audit/LLM_AUDIT_REPORT.md)" >> $GITHUB_STEP_SUMMARY
                  fi

                  echo "- ðŸ“¦ Artifacts uploaded for run #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**Next:** Review the report and address priority actions." >> $GITHUB_STEP_SUMMARY
