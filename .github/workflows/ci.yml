# GitHub Actions Workflow for Rustassistant
# Handles database setup correctly to avoid permission issues

name: CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  RUSTASSISTANT_ENV: production
  # Use a dedicated path for CI - avoids conflicts with local dev
  RUSTASSISTANT_DB_PATH: /tmp/rustassistant-ci/rustassistant.db

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-action@stable
        with:
          components: clippy, rustfmt

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Setup database directory
        run: |
          mkdir -p /tmp/rustassistant-ci
          chmod 777 /tmp/rustassistant-ci

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Run tests
        run: cargo test --all-features
        env:
          RUSTASSISTANT_AUTO_MIGRATE: true

  build:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-action@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Build release
        run: cargo build --release

      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: rustassistant-linux
          path: target/release/rustassistant
          retention-days: 7

  deploy:
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: rustassistant-linux
          path: ./bin

      - name: Deploy to server
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
        run: |
          # Setup SSH
          mkdir -p ~/.ssh
          echo "$DEPLOY_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H $DEPLOY_HOST >> ~/.ssh/known_hosts

          # Create data directory on server with correct permissions
          ssh $DEPLOY_USER@$DEPLOY_HOST << 'EOF'
            # Create directory if it doesn't exist
            sudo mkdir -p /var/lib/rustassistant
            sudo mkdir -p /var/lib/rustassistant/backups
            
            # Set ownership to deploy user (or create a dedicated user)
            sudo chown -R $USER:$USER /var/lib/rustassistant
            
            # Set permissions: owner full access, group read/write
            sudo chmod 775 /var/lib/rustassistant
            sudo chmod 775 /var/lib/rustassistant/backups
          EOF

          # Backup existing database before deploy
          ssh $DEPLOY_USER@$DEPLOY_HOST << 'EOF'
            if [ -f /var/lib/rustassistant/rustassistant.db ]; then
              TIMESTAMP=$(date +%Y%m%d_%H%M%S)
              cp /var/lib/rustassistant/rustassistant.db \
                 /var/lib/rustassistant/backups/rustassistant_${TIMESTAMP}.db
              echo "Database backed up"
            fi
          EOF

          # Copy binary
          scp ./bin/rustassistant $DEPLOY_USER@$DEPLOY_HOST:/opt/rustassistant/

          # Restart service
          ssh $DEPLOY_USER@$DEPLOY_HOST << 'EOF'
            sudo systemctl restart rustassistant
            sleep 2
            sudo systemctl status rustassistant --no-pager
          EOF

  # Optional: Scheduled database backup
  backup:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    steps:
      - name: Backup database to S3
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: us-east-1
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
        run: |
          # Setup SSH
          mkdir -p ~/.ssh
          echo "$DEPLOY_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H $DEPLOY_HOST >> ~/.ssh/known_hosts

          # Download database from server
          scp $DEPLOY_USER@$DEPLOY_HOST:/var/lib/rustassistant/rustassistant.db ./backup.db

          # Upload to S3
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          aws s3 cp ./backup.db s3://your-bucket/rustassistant/backups/rustassistant_${TIMESTAMP}.db

          # Keep only last 30 backups
          aws s3 ls s3://your-bucket/rustassistant/backups/ \
            | sort -r \
            | tail -n +31 \
            | awk '{print $4}' \
            | xargs -I {} aws s3 rm s3://your-bucket/rustassistant/backups/{}
